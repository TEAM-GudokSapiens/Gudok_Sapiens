{% extends 'base.html' %}
{% load taggit_templatetags2_tags %}

{% block content %}
<!--- 대분류 카테고리 표기-->
<div class="navbar">
  <a href="{% url 'services:services_list' %}">전체보기</a><!-- 전체보기 -->
  {% for category in categories %}
    <a href="{% url 'services:category_list' category.slug %}">{{ category.name }}</a>
  {% endfor %}
   <form method="GET" action="{% url 'services:search' %}"  >
    {% csrf_token %}
    <div class="form-row">
    <div class="col" style="margin-top: 10px;">
        <select style="width: 6em;" class="custom-select custom-select-md" name="type">
            <option value="all">전체</option>
            <option value="name">제목</option>
            <option value="intro">한줄 소개</option>
            <option value="content">내용</option>
        </select>
    </div>
    <div class="col" style="margin-top: 10px;">
        <input type='text' name='search_key' value="{{ search_key }}" placeholder='Search' />
    </div>
    <div class="col">
        <input type='submit' value="Search" />
    </div>
    </div>

    </form>
</div>



<!--- 세부 카테고리 표기-->
<div>
    <ul>
        <li>
            <a href="{% url 'services:services_list' %}" style="font-weight: 800;">전체보기</a><!-- 전체보기 -->
        </il>
        {% for category in categories %}
        <li>
            <a href="{% url 'services:category_list' category.slug %}" style="font-weight: 800;">{{ category.name }}</a>
            {% if category_slug == category.slug  %}
                <ul>
                {% if sub_category_list %}
                    {% for sub_category in sub_category_list  %}
                        <li>
                            <a href="{% url 'services:sub_category_list' category.slug sub_category.slug %}">{{ sub_category.name }}</a>
                        </li>
                    {% endfor %}
                {% endif %}
                </ul>
            {% endif %}
        </il>
        {% endfor %}
    </ul>
</div>
{% comment %} 본문 내용 서비스 나열 {% endcomment %}
<div class="album py-5 bg-light">
    <div class="container"> 
        <div class="flex row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
            {% if services %}
            {% for service in services  %}
            <div class="col">
                <div class="card service-id-{{ service.id }}">
                    <div class='card-img-top'>
                    {% if service.img1 %}
                    <a href="{% url 'services:services_detail' pk=service.pk %}"><img src="{{ service.img1.url }}" width='250px' /></a>
                    {% endif %}
                    </div>
                    <div class='card-body'>
                        {{ service.name }}
                        {{ service.intro }}
                        <div> 평균 ⭐️: {{ service.avg_reviews|floatformat:1 }} {{service.get_review_count}} 명</div>
                        <div class="dib__counts">찜: {{ service.dib_set.all.count }}</div>
                        {% comment %} {% if request.user.id in service.dib_set.id %} {% endcomment %}
                            {% comment %} <div class="btn btn-primary dib" onclick="onClickDib({{ service.id }})">안찜하기</div> {% endcomment %}
                        {% comment %} {% else %} {% endcomment %}
                            <div class="btn btn-primary dib" onclick="onClickDib({{ service.id }})">찜하기</div>
                        {% comment %} {% endif %} {% endcomment %}
                    </div>
                </div>
            </div>
            {% endfor %}

            {% else %}
            <div>
                <h5>조건에 맞는 구독 서비스가 없습니다.</h5> 
            </div>

            {% endif %}
            
        </div>
    </div>
</div>

<br/>

{% comment %} 하단 페이지 넘기기 기능 {% endcomment %}
<div>
    <ul class="pagination justify-content-center">
        <!-- 이전페이지 -->
        {% if services.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ services.previous_page_number }}">이전</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <a class="page-link" tabindex="-1" aria-disabled="true" href="#">이전</a>
        </li>
        {% endif %}
        <!-- 페이지리스트 -->
        {% for page_number in services.paginator.page_range %}
        {% if page_number >= services.number|add:-2 and page_number <= services.number|add:2 %}
            {% if page_number == services.number %}
            <li class="page-item active" aria-current="page">
                <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
            </li>
            {% endif %}
        {% endif %}
        {% endfor %}
        <!-- 다음페이지 -->
        {% if services.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ services.next_page_number }}">다음</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <a class="page-link" tabindex="-1" aria-disabled="true" href="#">다음</a>
        </li>
        {% endif %}
    </ul>
    <!-- 페이징처리 끝 -->
</div>
<script>  

        const requestDib = new XMLHttpRequest();

        const onClickDib = (id) => {
            
            requestDib.open('POST','/likes/dibs_ajax/', true);
            requestDib.setRequestHeader(
                'Content-type',
                'application/x-www-form-urlencoded'
            );
            requestDib.send(JSON.stringify({id: id}));
        };


        const DibHandleResponse = () => {
            if (requestDib.status < 400) {
                const {id} = JSON.parse(requestDib.response)
                const element = document.querySelector(`.service-id-${id} .dib`);
                //TODO: 전체 찜 갯수도 ajax구현
                //const dibs_counts = document.querySelector(`.service-id-${id} .dib__counts`).innerHTML;
                //const [dib, num] = dibs_counts.split(' ');
                
                if (element.innerHTML == `찜하기`) {
                    element.innerHTML = `안찜하기`
                    //const count = Number(num) + 1;
                    //dibs_counts = `찜: ${count}`
                    
                }
                else {
                    element.innerHTML = `안찜하기`;
                    element.innerHTML == `찜하기`;
                    //const count = Number(num) -1;
                    //dibs_counts = `찜: ${count}`
                }

            }
        }
        requestDib.onreadystatechange = () => {
            if (requestDib.readyState === XMLHttpRequest.DONE) {
                DibHandleResponse();
            }
        } 
</script>  

{% endblock %}